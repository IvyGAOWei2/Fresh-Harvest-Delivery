{% extends "_employee-base.html" %}

{% block sidebar %}
{% with is_manageProduct='1' %}
{% include "components/layout/Sidebar.html" %}
{% endwith %}
{% endblock %}

{% block breadcrumb %}
{% with pageName='Products' %}
{% include "components/layout/Breadcrumb2.html" %}
{% endwith %}
{% endblock %}

{% block content %}
<style>
    /* Pagination styling */
    .pagination a {
        color: #007bff;
        padding: 10px 15px;
        text-decoration: none;
        transition: background-color 0.3s;
        border-radius: 5px;
        margin: 0 5px;
    }

    .pagination a.active {
        background-color: #007bff;
        color: white;
        border-radius: 5px;
    }

    .pagination a:hover:not(.active) {
        background-color: #ddd;
        border-radius: 5px;
    }

    /* button style */
    .btn-primary:hover {
      transform: scale(1.1);
    }

    .btn-secondary:hover {
      transform: scale(1.2);
      background-color: 177, 205, 252;
      color: #fff;
      border-color: #0c0c0c
    }


</style>

<section class="main-content">
    <h1 class="text-center">Product Management</h1>
    <div class="container mt-5">
        <!-- search & sorting & add new button -->
        <div class="d-flex  align-items-center mb-3">
            <!-- search -->
            <div class="col-xl-3">
                <div class="input-group">
                    <input type="search" class="form-control p-2" placeholder="keywords"
                        aria-describedby="search-icon-1">
                    <span id="search-icon-1" class="input-group-text p-3"><i class="fa fa-search"></i></span>
                </div>
            </div>

            <!-- sorting -->
            <div class="d-flex align-items-center ms-4">
                <div class="me-3">
                    <label for="" class="form-label mb-0 me-1 " style="color: black">Category: </label>
                    <select id="" name="" class="border-0 form-select-sm bg-light border-0 me-3">
                        <option value="Fruit">Fruit</option>
                        <option value="Vegetable">Vegetable</option>
                        <option value="Herb">Herb</option>
                        <option value="Salad">Salad</option>
                        <option value="Egg">Egg</option>
                        <option value="Honey">Honey</option>
                        <option value="GiftCard">GiftCard</option>
                    </select>
                </div>
            </div>

            <!-- Button trigger modal to add product-->
            <button class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#addProductModal">Add New
                Product</button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered text-center">
                <thead class="table-primary">
                    <tr>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    {% for product in productList %}
                    <tr>
                        <td class="align-middle fw-bold">{{ product[1] }}</td>
                        <td class="align-middle">{{ product[5] }}</td>
                        <td class="align-middle">{{ product[3] }}</td>
                        <td class="align-middle">{{ product[4] }}</td>
                        <td>
                            <a class="btn product-update" role="button" data-bs-toggle="offcanvas"
                                data-bs-target="#updateproduct{{ product[0] }}" data-product-id="{{ product[0] }}">
                                <i class="fas fa-edit fa-lg me-3 fa-fw" title="Update Info"></i>
                            </a>
                            <a class="btn product-del" role="button" data-product-id="{{product[0]}}">
                                <i class="fas fa-store-slash fa-lg me-3" title="Delist the Product"></i> 
                            </a>
                        </td> 
                    </tr>

                    <!-- Update Product offcanvas -->
                    <div class="offcanvas offcanvas-end w-50" id="updateproduct{{ product[0] }}" tabindex="-1"
                        aria-labelledby="updateProductModalLabel">
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title text-center" id="updateproductLabel">Update {{product[1]}}</h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                                aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body">
                            <form id="updateProductForm{{ product[0] }}"  action ="/product/update" method="POST">
                                <!-- 图片上传及展示部分需要修改 -->
                                <div class="card shadow-sm" style="width: 8vw;">
                                    <label for="imgUpdate{{ product[0] }}">                                  
                                        <!-- 图片占位符 -->
                                        <img src="{{ url_for('static', filename='images/product/' + product[8]) }}" class="card-img-top" id="imagePreview{{ product[0] }}">
                                    </label>
                                    <input class="form-control" type="file" id="imgUpdate{{ product[0] }}" style="display: none;" accept="image/*">
                                </div>

                                <div class="mb-3">
                                    <label for="updateProductName" class="form-label">Product Name</label>
                                    <input type="text" minlength="1" maxlength="50" id="updateProductName" name="name" pattern="^[a-zA-Z\s]+$" class="form-control" value="{{product[1]}}" required>
                                    <div class="invalid-feedback">Please enter a valid product name, only letters and spaces.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="updateCategory" class="form-label">Category</label>
                                    <input type="text" class="form-control" value="{{product[5]}}" id="updateCategory" name = "category_name" minlength="1" maxlength="50" pattern="^[a-zA-Z\s]+$" required>
                                    <div class="invalid-feedback">Please enter a valid category name, only letters and spaces.</div>
                                </div>
                                <div>
                                    <label for="updateDescription" class="form-label">Description</label>
                                    <textarea rows="5"  type="text" class="form-control form-textarea"
                                        id="updateDescription" name = "description" minlength="1"  pattern="^[a-zA-Z0-9,.!?;:\s']+$" required>{{product[2]}}</textarea>
                                    <div class="invalid-feedback">Please enter a valid description with at least 1 characters.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="updatePrice" class="form-label">Price</label>
                                    <input type="number" class="form-control" value="{{product[3]}}" id="updatePrice" name = "price" min="0" step="0.01" 
                                        required>
                                    <div class="invalid-feedback">Please enter a valid price amount, numbers only.</div> 
                                </div>
                                <div class="mb-3">
                                    <label for="updateStock" class="form-label">Stock</label>
                                    <input type="number" class="form-control" value="{{product[4]}}" id="updateStock" name="stock" min="0" required>
                                    <div class="invalid-feedback">Please enter a valid stock amount, numbers only.</div>

                                </div>
                                <button type="submit" class="btn btn-primary">Update</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- pagination -->
    <nav aria-label="manageProduct">
        <ul class="pagination d-flex justify-content-center mt-5">
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">4</a></li>
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addProductForm" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addProductName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="addProductName" name = "name" minlength="1" maxlength="50" pattern="^[a-zA-Z\s]+$" required>
                            <div class="invalid-feedback">Please enter a valid product name, only letters and spaces.</div>
                        </div>
                        <div class="mb-3">
                            <label for="addCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="addCategory" name = "category_name" minlength="1" maxlength="50" pattern="^[a-zA-Z\s]+$" required>
                            <div class="invalid-feedback">Please enter a valid category name, only letters and spaces.</div>
                        </div>
                        <div class="mb-3">
                            <label for="addDescription" class="form-label">Description</label>
                            <textarea type="text" class="form-control form-textarea" id="addDescription" name = "description" minlength="1"  pattern="^[a-zA-Z0-9,.!?;:\s']+$" required> </textarea>
                            <div class="invalid-feedback">Please enter a valid description with at least 1 characters.</div>
                        </div>
                        <div class="mb-3">
                            <label for="addPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="addPrice" name = "price" min="0" step="0.01" required>
                            <div class="invalid-feedback">Please enter a valid price, numbers only.</div>
                        </div>
                        <div class="mb-3">
                            <label for="addStock" class="form-label">Stock</label>
                            <input type="number" class="form-control" id="addStock" name="stock" min="0" required>
                            <div class="invalid-feedback">Please enter a valid stock amount, numbers only.</div>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary"> Upload Image </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <!-- 按钮增加边距 -->
                        <button type="submit" class="btn btn-primary"> Add </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
        <!-- Update Success btn code start here -->
        {% with
          btn_show = 1,
          btn_text = 'Update Success',
          bg_color = '#81C408',
          title = 'Update Success',
          msg = 'Your {item} has been successfully added'
        %}
            {% include "components/elements/addSuccess.html" %}
        {% endwith %}
        <!-- Update Success btn code end here -->

        {% with
            btn_show = 0,
            modal_id = 'deleteMemberModal',
            title = 'Delete Confirmation',
            msg = 'Are you sure to delete this product?'
          %}
            {% include "components/elements/delConfirm2.html" %}
          {% endwith %}

</section>
{% endblock %}



{% block script %}
    {% include "components/elements/InputValidate.html" %}

    <script>
    // validation
        //  update product validation
    document.getElementById('updateProductName').addEventListener('input', function() {
            InputValidate('updateProductName');
        });
    document.getElementById('updateCategory').addEventListener('input', function() {
            InputValidate('updateCategory');
        });
    document.getElementById('updateDescription').addEventListener('input', function() {
            InputValidate('updateDescription');
        });
    document.getElementById('updatePrice').addEventListener('input', function() {
            InputValidate('updatePrice');
        });
    document.getElementById('updateStock').addEventListener('input', function() {
            InputValidate('updateStock');
        });

        //  New product validation
    document.getElementById('addProductName').addEventListener('input', function() {
        InputValidate('addProductName');
    });
    document.getElementById('addCategory').addEventListener('input', function() {
            InputValidate('addCategory');
        });
    document.getElementById('addDescription').addEventListener('input', function() {
            InputValidate('addDescription');
        });
    document.getElementById('addPrice').addEventListener('input', function() {
            InputValidate('addPrice');
        });
    document.getElementById('addStock').addEventListener('input', function() {
            InputValidate('addStock');
        });






        // // Add product
        // let addProductData = {};

        document.addEventListener('DOMContentLoaded', function () {
        //     // addSuccessModal 是boostrap自带的吗？html页面有自行再定义吗
        document.getElementById('addSuccessModal').addEventListener('hidden.bs.modal', () => location.reload());

        //     const productTableBody = document.getElementById('productTableBody');
        //     const updateProductForm = document.getElementById('updateProductForm');
        //     const addProductForm = document.getElementById('addProductForm');

        //     addProductForm.addEventListener('input', event => {
        //         // console.log(event.target.name)
        //         // console.log(event.target.value)
        //         const keyName = event.target.name;
        //         const keyValue = event.target.value;

        //         addProductData[keyName] = keyValue;
        //         // 新增商品的id是自动生成的吗?这样设置？
        //         addProductData[product_id] = product_id;

            const addProductForm = document.getElementById('addProductForm');

            // Handle add form submission
            addProductForm.addEventListener('submit', function (event) {
                if (!addProductForm.checkValidity()) return // Stop further execution if form is invalid
                event.preventDefault();
                event.stopPropagation();

                const formData = new FormData(this); // Prepare form data

                // Send login request to flask server
                fetch('/product/add', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status == true) { // Redirect user if login is successful
                            console.log(data)
                            // Show updateStaffSuccess modal if update is successful
                            new bootstrap.Modal(document.getElementById('addSuccessModal')).show();
                        }
                        else {
                            alert("Invalid request");
                            location.reload(); // Reload the page on failure
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });






            // Handle update form submission
            // updateProductForm.addEventListener('submit', function (event) {
            //     event.preventDefault();
            //     const productId = parseInt(document.getElementById('updateProductModal').getAttribute('data-product-id'));
            //     const updatedProduct = {
            //         id: productId,
            //         name: document.getElementById('updateProductName').value,
            //         category: document.getElementById('updateCategory').value,
            //         price: parseFloat(document.getElementById('updatePrice').value),
            //         stock: parseInt(document.getElementById('updateStock').value),
            //     };
            //     products = products.map(p => p.id === productId ? updatedProduct : p);
            //     renderProductRows();
            //     bootstrap.Modal.getInstance(document.getElementById('updateProductModal')).hide();
            // });


            // del product
            const productDel = document.querySelectorAll('.product-del');

            // Iterate over all delete buttons
            productDel.forEach(function (del) {
                // Add click event listener to each delete button
                del.addEventListener('click', function (event) {
                    event.preventDefault();

                    // Show delConfirm modal when delete button is clicked
                    new bootstrap.Modal(document.getElementById('deleteMemberModal')).show();
                    var confirmButton = document.querySelector('#deleteMemberModal .modal-footer .btn-primary');

                    // Add click event listener to the confirmButton
                    confirmButton.addEventListener('click', function () {
                        // Send request to server
                        fetch('/product/delist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({'product_id': del.getAttribute('data-product-id')})
                        })
                        .then(response => response.json())
                        .then(data => {
                        if (data.status) {
                            // Reload page if deletion is successful
                            location.reload()
                        }
                        else {
                            alert("Invalid request");
                        }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
            });

        });


    </script>

{% endblock %}